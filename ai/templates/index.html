<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoteSure - Face Verification</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .webcam-container, .upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .camera-box {
            width: 320px;
            height: 240px;
            border: 2px dashed #ccc;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            position: relative;
            overflow: hidden;
        }
        .camera-box video, .camera-box img {
            max-width: 100%;
            max-height: 100%;
        }
        .camera-box canvas {
            display: none;
        }
        .preview-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .capture-btn {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.7);
        }
        .tab-content {
            padding: 20px 0;
        }
        .result-card {
            transition: all 0.3s ease;
        }
        .upload-box {
            width: 320px;
            height: 240px;
            border: 2px dashed #ccc;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .upload-box:hover {
            border-color: #0d6efd;
        }
        .upload-box i {
            font-size: 48px;
            margin-bottom: 10px;
            color: #6c757d;
        }
        #drop-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
            margin-bottom: 20px;
        }
        #drop-area.highlight {
            border-color: #0d6efd;
            background-color: #e9f2ff;
        }
        .verification-result {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        .verification-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .verification-failed {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .progress-container {
            margin-top: 15px;
            display: none;
        }
        .hidden-file-input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <header class="text-center mb-5">
            <h1 class="display-4">VoteSure Face Verification</h1>
            <p class="lead">Verify identity by comparing faces using AI</p>
        </header>

        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active text-dark" id="webcam-tab" data-bs-toggle="tab" data-bs-target="#webcam" type="button" role="tab" aria-controls="webcam" aria-selected="true">
                                    <i class="fas fa-camera me-2"></i>Webcam
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link text-dark" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab" aria-controls="upload" aria-selected="false">
                                    <i class="fas fa-upload me-2"></i>Upload Images
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="myTabContent">
                            <!-- Webcam Tab -->
                            <div class="tab-pane fade show active" id="webcam" role="tabpanel" aria-labelledby="webcam-tab">
                                <div class="text-center mb-4">
                                    <p>Use your webcam to capture reference and verification photos</p>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="webcam-container">
                                            <h5>Reference Image</h5>
                                            <div class="camera-box" id="reference-camera">
                                                <video id="reference-video" autoplay playsinline></video>
                                                <canvas id="reference-canvas"></canvas>
                                                <button id="reference-capture" class="btn btn-sm btn-primary capture-btn">
                                                    <i class="fas fa-camera me-1"></i> Capture
                                                </button>
                                            </div>
                                            <div class="camera-box" id="reference-preview" style="display: none;">
                                                <img id="reference-preview-img" class="preview-image">
                                                <button id="reference-retake" class="btn btn-sm btn-secondary capture-btn">
                                                    <i class="fas fa-redo me-1"></i> Retake
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-4">
                                        <div class="webcam-container">
                                            <h5>Verification Image</h5>
                                            <div class="camera-box" id="verification-camera">
                                                <video id="verification-video" autoplay playsinline></video>
                                                <canvas id="verification-canvas"></canvas>
                                                <button id="verification-capture" class="btn btn-sm btn-primary capture-btn">
                                                    <i class="fas fa-camera me-1"></i> Capture
                                                </button>
                                            </div>
                                            <div class="camera-box" id="verification-preview" style="display: none;">
                                                <img id="verification-preview-img" class="preview-image">
                                                <button id="verification-retake" class="btn btn-sm btn-secondary capture-btn">
                                                    <i class="fas fa-redo me-1"></i> Retake
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-3">
                                    <button id="verify-webcam" class="btn btn-primary" disabled>
                                        <i class="fas fa-check-double me-2"></i>Verify Faces
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Upload Tab -->
                            <div class="tab-pane fade" id="upload" role="tabpanel" aria-labelledby="upload-tab">
                                <div class="text-center mb-4">
                                    <p>Upload reference and verification images to compare</p>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="upload-container">
                                            <h5>Reference Image</h5>
                                            <div class="upload-box" id="reference-upload-box">
                                                <i class="fas fa-upload"></i>
                                                <p>Click to select or drag an image</p>
                                                <input type="file" id="reference-file" class="hidden-file-input" accept="image/*">
                                            </div>
                                            <div class="camera-box" id="reference-upload-preview" style="display: none;">
                                                <img id="reference-upload-img" class="preview-image">
                                                <button id="reference-upload-change" class="btn btn-sm btn-secondary capture-btn">
                                                    <i class="fas fa-redo me-1"></i> Change
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-4">
                                        <div class="upload-container">
                                            <h5>Verification Image</h5>
                                            <div class="upload-box" id="verification-upload-box">
                                                <i class="fas fa-upload"></i>
                                                <p>Click to select or drag an image</p>
                                                <input type="file" id="verification-file" class="hidden-file-input" accept="image/*">
                                            </div>
                                            <div class="camera-box" id="verification-upload-preview" style="display: none;">
                                                <img id="verification-upload-img" class="preview-image">
                                                <button id="verification-upload-change" class="btn btn-sm btn-secondary capture-btn">
                                                    <i class="fas fa-redo me-1"></i> Change
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-3">
                                    <button id="verify-upload" class="btn btn-primary" disabled>
                                        <i class="fas fa-check-double me-2"></i>Verify Faces
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Verification Results -->
                        <div class="progress-container" id="progress-container">
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">Processing...</div>
                            </div>
                        </div>
                        
                        <div class="verification-result" id="verification-result">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <h4 id="result-title">Verification Result</h4>
                                    <div id="result-message"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Similarity Score</h5>
                                        </div>
                                        <div class="card-body text-center">
                                            <div class="display-4 mb-2" id="similarity-score">--</div>
                                            <div class="progress mb-3" style="height: 20px;">
                                                <div class="progress-bar" id="similarity-progress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                            <p class="text-muted" id="threshold-info">Threshold: --</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Technical Details</h5>
                                        </div>
                                        <div class="card-body">
                                            <ul class="list-group list-group-flush">
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Model
                                                    <span id="model-name">--</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Distance
                                                    <span id="distance-value">--</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Detector
                                                    <span id="detector-value">--</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Webcam variables
            let referenceStream = null;
            let verificationStream = null;
            let referenceImage = null;
            let verificationImage = null;
            let referenceUploadImage = null;
            let verificationUploadImage = null;
            
            // Webcam elements
            const referenceVideo = document.getElementById('reference-video');
            const verificationVideo = document.getElementById('verification-video');
            const referenceCanvas = document.getElementById('reference-canvas');
            const verificationCanvas = document.getElementById('verification-canvas');
            const referencePreviewImg = document.getElementById('reference-preview-img');
            const verificationPreviewImg = document.getElementById('verification-preview-img');
            
            // Camera containers
            const referenceCamera = document.getElementById('reference-camera');
            const verificationCamera = document.getElementById('verification-camera');
            const referencePreview = document.getElementById('reference-preview');
            const verificationPreview = document.getElementById('verification-preview');
            
            // Buttons
            const referenceCapture = document.getElementById('reference-capture');
            const verificationCapture = document.getElementById('verification-capture');
            const referenceRetake = document.getElementById('reference-retake');
            const verificationRetake = document.getElementById('verification-retake');
            const verifyWebcam = document.getElementById('verify-webcam');
            
            // Upload elements
            const referenceFile = document.getElementById('reference-file');
            const verificationFile = document.getElementById('verification-file');
            const referenceUploadBox = document.getElementById('reference-upload-box');
            const verificationUploadBox = document.getElementById('verification-upload-box');
            const referenceUploadPreview = document.getElementById('reference-upload-preview');
            const verificationUploadPreview = document.getElementById('verification-upload-preview');
            const referenceUploadImg = document.getElementById('reference-upload-img');
            const verificationUploadImg = document.getElementById('verification-upload-img');
            const referenceUploadChange = document.getElementById('reference-upload-change');
            const verificationUploadChange = document.getElementById('verification-upload-change');
            const verifyUpload = document.getElementById('verify-upload');
            
            // Result elements
            const progressContainer = document.getElementById('progress-container');
            const verificationResult = document.getElementById('verification-result');
            const resultTitle = document.getElementById('result-title');
            const resultMessage = document.getElementById('result-message');
            const similarityScore = document.getElementById('similarity-score');
            const similarityProgress = document.getElementById('similarity-progress');
            const thresholdInfo = document.getElementById('threshold-info');
            const modelName = document.getElementById('model-name');
            const distanceValue = document.getElementById('distance-value');
            const detectorValue = document.getElementById('detector-value');
            
            // Initialize webcam
            async function initWebcam() {
                try {
                    const constraints = {
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        }
                    };
                    
                    // Initialize reference camera
                    referenceStream = await navigator.mediaDevices.getUserMedia(constraints);
                    referenceVideo.srcObject = referenceStream;
                    
                    // Initialize verification camera (same stream)
                    verificationStream = referenceStream;
                    verificationVideo.srcObject = verificationStream;
                    
                } catch (err) {
                    console.error('Error accessing webcam:', err);
                    alert('Error accessing webcam. Please make sure your camera is connected and permissions are granted.');
                }
            }
            
            // Initialize webcam when tab is active
            document.getElementById('webcam-tab').addEventListener('click', function() {
                if (!referenceStream) {
                    initWebcam();
                }
            });
            
            // Initialize on page load if webcam tab is active
            if (document.getElementById('webcam-tab').classList.contains('active')) {
                initWebcam();
            }
            
            // Capture reference image
            referenceCapture.addEventListener('click', function() {
                captureImage('reference');
                updateVerifyButtonState();
            });
            
            // Capture verification image
            verificationCapture.addEventListener('click', function() {
                captureImage('verification');
                updateVerifyButtonState();
            });
            
            // Retake reference image
            referenceRetake.addEventListener('click', function() {
                referencePreview.style.display = 'none';
                referenceCamera.style.display = 'flex';
                referenceImage = null;
                updateVerifyButtonState();
            });
            
            // Retake verification image
            verificationRetake.addEventListener('click', function() {
                verificationPreview.style.display = 'none';
                verificationCamera.style.display = 'flex';
                verificationImage = null;
                updateVerifyButtonState();
            });
            
            // Capture image from video
            function captureImage(type) {
                const video = type === 'reference' ? referenceVideo : verificationVideo;
                const canvas = type === 'reference' ? referenceCanvas : verificationCanvas;
                const previewImg = type === 'reference' ? referencePreviewImg : verificationPreviewImg;
                const cameraBox = type === 'reference' ? referenceCamera : verificationCamera;
                const previewBox = type === 'reference' ? referencePreview : verificationPreview;
                
                // Set canvas dimensions to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Draw video frame to canvas
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Get data URL from canvas
                const dataUrl = canvas.toDataURL('image/jpeg');
                
                // Update preview image
                previewImg.src = dataUrl;
                
                // Hide camera, show preview
                cameraBox.style.display = 'none';
                previewBox.style.display = 'flex';
                
                // Store image data
                if (type === 'reference') {
                    referenceImage = dataUrl;
                } else {
                    verificationImage = dataUrl;
                }
            }
            
            // Handle file selection with resize option for large images
            referenceFile.addEventListener('change', function(e) {
                handleFileSelect(e, 'reference');
                updateVerifyButtonState();
            });
            
            verificationFile.addEventListener('change', function(e) {
                handleFileSelect(e, 'verification');
                updateVerifyButtonState();
            });
            
            // File upload box click handlers
            referenceUploadBox.addEventListener('click', function() {
                referenceFile.click();
            });
            
            verificationUploadBox.addEventListener('click', function() {
                verificationFile.click();
            });
            
            // Handle change button clicks
            referenceUploadChange.addEventListener('click', function() {
                referenceUploadPreview.style.display = 'none';
                referenceUploadBox.style.display = 'flex';
                referenceUploadImage = null;
                updateVerifyButtonState();
            });
            
            verificationUploadChange.addEventListener('click', function() {
                verificationUploadPreview.style.display = 'none';
                verificationUploadBox.style.display = 'flex';
                verificationUploadImage = null;
                updateVerifyButtonState();
            });
            
            // Also add drag and drop support for upload boxes
            [referenceUploadBox, verificationUploadBox].forEach(function(uploadBox) {
                uploadBox.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.style.borderColor = '#0d6efd';
                    this.style.backgroundColor = '#e9f2ff';
                });
                
                uploadBox.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.style.borderColor = '#ccc';
                    this.style.backgroundColor = '#f8f9fa';
                });
                
                uploadBox.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.style.borderColor = '#ccc';
                    this.style.backgroundColor = '#f8f9fa';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const type = this.id.includes('reference') ? 'reference' : 'verification';
                        const fileInput = type === 'reference' ? referenceFile : verificationFile;
                        
                        // Update the file input
                        fileInput.files = files;
                        
                        // Trigger the change event manually
                        const event = new Event('change', { bubbles: true });
                        fileInput.dispatchEvent(event);
                    }
                });
            });
            
            // Process selected file with resize option for large images
            function handleFileSelect(event, type) {
                const file = event.target.files[0];
                if (file && file.type.match('image.*')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const imageUrl = e.target.result;
                        
                        // Create an image element to get dimensions
                        const img = new Image();
                        img.onload = function() {
                            // Log original image dimensions
                            console.log(`Original image dimensions: ${img.width}x${img.height}, size: ${Math.round(file.size / 1024)} KB`);
                            
                            // Check if image is very large
                            const MAX_WIDTH = 1200;
                            const MAX_HEIGHT = 1200;
                            
                            let finalImageUrl = imageUrl;
                            
                            // Resize large images to improve performance
                            if (img.width > MAX_WIDTH || img.height > MAX_HEIGHT || file.size > 5 * 1024 * 1024) {
                                console.log('Image is large, resizing before upload...');
                                
                                // Create canvas for resizing
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;
                                
                                // Calculate new dimensions
                                if (width > height) {
                                    if (width > MAX_WIDTH) {
                                        height *= MAX_WIDTH / width;
                                        width = MAX_WIDTH;
                                    }
                                } else {
                                    if (height > MAX_HEIGHT) {
                                        width *= MAX_HEIGHT / height;
                                        height = MAX_HEIGHT;
                                    }
                                }
                                
                                // Set canvas size
                                canvas.width = width;
                                canvas.height = height;
                                
                                // Draw resized image on canvas
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                
                                // Get resized image as data URL (JPEG with 90% quality)
                                finalImageUrl = canvas.toDataURL('image/jpeg', 0.9);
                                console.log(`Resized image dimensions: ${width}x${height}`);
                            }
                            
                            // Set image preview and store for submission
                            if (type === 'reference') {
                                referenceUploadImg.src = finalImageUrl;
                                referenceUploadBox.style.display = 'none';
                                referenceUploadPreview.style.display = 'flex';
                                referenceUploadImage = finalImageUrl;
                            } else {
                                verificationUploadImg.src = finalImageUrl;
                                verificationUploadBox.style.display = 'none';
                                verificationUploadPreview.style.display = 'flex';
                                verificationUploadImage = finalImageUrl;
                            }
                            
                            // Immediately update button state
                            updateVerifyButtonState();
                        };
                        
                        // Load the image to get dimensions
                        img.src = imageUrl;
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
            
            // Update the state of verify buttons
            function updateVerifyButtonState() {
                // Webcam tab
                if (referenceImage && verificationImage) {
                    verifyWebcam.disabled = false;
                } else {
                    verifyWebcam.disabled = true;
                }
                
                // Upload tab
                if (referenceUploadImage && verificationUploadImage) {
                    verifyUpload.disabled = false;
                } else {
                    verifyUpload.disabled = true;
                }
            }
            
            // Verify webcam images
            verifyWebcam.addEventListener('click', function() {
                if (referenceImage && verificationImage) {
                    performVerification(referenceImage, verificationImage);
                }
            });
            
            // Verify uploaded images
            verifyUpload.addEventListener('click', function() {
                if (referenceUploadImage && verificationUploadImage) {
                    performVerification(referenceUploadImage, verificationUploadImage);
                }
            });
            
            // Perform face verification
            async function performVerification(img1, img2) {
                // Show progress and hide results
                progressContainer.style.display = 'block';
                verificationResult.style.display = 'none';
                
                try {
                    // Create form data
                    const formData = new FormData();
                    formData.append('reference_image', img1);
                    formData.append('verification_image', img2);
                    
                    // Send to API
                    const response = await fetch('/api/verify-face-base64', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Verification failed');
                    }
                    
                    const result = await response.json();
                    displayResults(result);
                    
                } catch (error) {
                    console.error('Error during verification:', error);
                    
                    // Display error
                    resultTitle.textContent = 'Verification Error';
                    resultMessage.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${error.message || 'An error occurred during face verification'}
                        </div>
                    `;
                    
                    // Clear other fields
                    similarityScore.textContent = '--';
                    similarityProgress.style.width = '0%';
                    thresholdInfo.textContent = 'Threshold: --';
                    modelName.textContent = '--';
                    distanceValue.textContent = '--';
                    detectorValue.textContent = '--';
                    
                    // Show result
                    progressContainer.style.display = 'none';
                    verificationResult.style.display = 'block';
                    verificationResult.className = 'verification-result';
                }
            }
            
            // Display verification results
            function displayResults(result) {
                // Update result fields
                const scoreValue = result.similarity_score.toFixed(2);
                similarityScore.textContent = `${scoreValue}%`;
                similarityProgress.style.width = `${scoreValue}%`;
                thresholdInfo.textContent = `Threshold: ${(result.threshold * 100).toFixed(2)}%`;
                modelName.textContent = result.model;
                distanceValue.textContent = result.distance.toFixed(4);
                detectorValue.textContent = result.detector_backend;
                
                // Check for anti-spoofing information
                let spoofingMessage = '';
                if (result.anti_spoofing) {
                    const refScore = result.anti_spoofing.reference_score ? 
                        `${(result.anti_spoofing.reference_score * 100).toFixed(1)}%` : 
                        'N/A';
                    const verScore = result.anti_spoofing.verification_score ? 
                        `${(result.anti_spoofing.verification_score * 100).toFixed(1)}%` : 
                        'N/A';
                    
                    let detailsHtml = '';
                    if (result.anti_spoofing.details) {
                        const details = result.anti_spoofing.details;
                        if (details.reference && details.verification) {
                            detailsHtml = `
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <strong>Technical Details:</strong>
                                        <ul class="mb-0">
                                            <li>Reference image screen signature: ${(details.reference.screen_score * 100).toFixed(1)}%</li>
                                            <li>Verification image screen signature: ${(details.verification.screen_score * 100).toFixed(1)}%</li>
                                            <li>Reference image texture analysis: ${(details.reference.texture_variation).toFixed(2)}</li>
                                            <li>Verification image texture analysis: ${(details.verification.texture_variation).toFixed(2)}</li>
                                        </ul>
                                    </small>
                                </div>
                            `;
                        }
                    }
                    
                    spoofingMessage = `
                        <div class="alert alert-info mt-2">
                            <i class="fas fa-shield-alt me-2"></i>
                            <strong>Anti-spoofing check:</strong> 
                            <span class="badge bg-success">Passed</span>
                            <div class="mt-1">
                                <small>Reference image real score: ${refScore}</small><br>
                                <small>Verification image real score: ${verScore}</small>
                            </div>
                            ${detailsHtml}
                        </div>
                    `;
                }
                
                // Set result title and message
                if (result.verified) {
                    resultTitle.textContent = 'Faces Match!';
                    resultMessage.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            The two faces belong to the same person with ${scoreValue}% similarity.
                        </div>
                        ${spoofingMessage}
                    `;
                    similarityProgress.className = 'progress-bar bg-success';
                } else {
                    resultTitle.textContent = 'Faces Do Not Match';
                    resultMessage.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            The two faces appear to be different people. Similarity (${scoreValue}%) is below the threshold.
                        </div>
                        ${spoofingMessage}
                    `;
                    similarityProgress.className = 'progress-bar bg-danger';
                }
                
                // Hide progress, show result
                progressContainer.style.display = 'none';
                verificationResult.style.display = 'block';
            }
        });
    </script>
</body>
</html> 